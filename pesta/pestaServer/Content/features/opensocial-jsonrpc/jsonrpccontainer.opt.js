var JsonRpcContainer=function(e,g,f){opensocial.Container.call(this);var d={};for(var b in f){if(f.hasOwnProperty(b)){d[b]={};for(var c=0;c<f[b].length;c++){var a=f[b][c];d[b][a]=true}}}this.environment_=new opensocial.Environment(g,d);this.baseUrl_=e;this.securityToken_=shindig.auth.getSecurityToken();gadgets.rpc.register("shindig.requestShareApp_callback",JsonRpcContainer.requestShareAppCallback_)};(function(){var a={};JsonRpcContainer.inherits(opensocial.Container);var b=function(d,c){this.rpc=d;this.processData=c||function(e){return e};this.processResponse=function(e,h,g,f){var i=g?JsonRpcContainer.translateHttpError("Error "+g.code):null;return new opensocial.ResponseItem(e,g?null:this.processData(h),i,f)}};JsonRpcContainer.prototype.getEnvironment=function(){return this.environment_};JsonRpcContainer.prototype.requestShareApp=function(g,i,d,e){var f="cId_"+Math.random();a[f]=d;var c=gadgets.util.unescapeString(i.getField(opensocial.Message.Field.BODY));if(!c||c.length===0){var h=gadgets.util.unescapeString(i.getField(opensocial.Message.Field.BODY_ID));c=gadgets.Prefs.getMsg(h)}gadgets.rpc.call("..","shindig.requestShareApp",null,f,g,c)};JsonRpcContainer.requestShareAppCallback_=function(g,h,d,f){callback=a[g];if(callback){a[g]=null;var e=null;if(f){e={recipientIds:f}}var c=new opensocial.ResponseItem(null,e,d);callback(c)}};JsonRpcContainer.prototype.requestCreateActivity=function(f,d,c){c=c||function(){};var e=opensocial.newDataRequest();var g=new opensocial.IdSpec({userId:"VIEWER"});e.add(this.newCreateActivityRequest(g,f),"key");e.send(function(h){c(h.get("key"))})};JsonRpcContainer.prototype.requestData=function(h,m){m=m||function(){};var f=h.getRequestObjects();var k=f.length;if(k===0){window.setTimeout(function(){m(new opensocial.DataResponse({},true))},0);return}var n=new Array(k);for(var g=0;g<k;g++){var l=f[g];n[g]=l.request.rpc;if(l.key){n[g].id=l.key}}var d=function(y){if(y.errors[0]){JsonRpcContainer.generateErrorResponse(y,f,m);return}y=y.data;var o=false;var x={};for(var s=0;s<y.length;s++){y[y[s].id]=y[s]}for(var p=0;p<f.length;p++){var r=f[p];var q=y[p];if(r.key&&q.id!==r.key){throw"Request key("+r.key+") and response id("+q.id+") do not match"}var j=q.data;var v=q.error;var u="";if(v){u=v.message}var t=r.request.processResponse(r.request,j,v,u);o=o||t.hadError();if(r.key){x[r.key]=t}}var w=new opensocial.DataResponse(x,o);m(w)};var i={CONTENT_TYPE:"JSON",METHOD:"POST",AUTHORIZATION:"SIGNED",POST_DATA:gadgets.json.stringify(n)};var c=[this.baseUrl_,"/social/rpc"];var e=shindig.auth.getSecurityToken();if(e){c.push("?st=",encodeURIComponent(e))}this.sendRequest(c.join(""),d,i,"application/json")};JsonRpcContainer.prototype.sendRequest=function(c,f,d,e){gadgets.io.makeNonProxiedRequest(c,f,d,e)};JsonRpcContainer.generateErrorResponse=function(c,f,h){var d=JsonRpcContainer.translateHttpError(c.errors[0]||c.data.error)||opensocial.ResponseItem.Error.INTERNAL_ERROR;var g={};for(var e=0;e<f.length;e++){g[f[e].key]=new opensocial.ResponseItem(f[e].request,null,d)}h(new opensocial.DataResponse(g,true))};JsonRpcContainer.translateHttpError=function(c){if(c==="Error 501"){return opensocial.ResponseItem.Error.NOT_IMPLEMENTED}else{if(c==="Error 401"){return opensocial.ResponseItem.Error.UNAUTHORIZED}else{if(c==="Error 403"){return opensocial.ResponseItem.Error.FORBIDDEN}else{if(c==="Error 400"){return opensocial.ResponseItem.Error.BAD_REQUEST}else{if(c==="Error 500"){return opensocial.ResponseItem.Error.INTERNAL_ERROR}else{if(c==="Error 404"){return opensocial.ResponseItem.Error.BAD_REQUEST}else{if(c==="Error 417"){return opensocial.ResponseItem.Error.LIMIT_EXCEEDED}}}}}}}};JsonRpcContainer.prototype.makeIdSpec=function(c){return new opensocial.IdSpec({userId:c})};JsonRpcContainer.prototype.translateIdSpec=function(c){var f=c.getField("userId");var e=c.getField("groupId");if(!opensocial.Container.isArray(f)){f=[f]}for(var d=0;d<f.length;d++){if(f[d]==="OWNER"){f[d]="@owner"}else{if(f[d]==="VIEWER"){f[d]="@viewer"}}}if(e==="FRIENDS"){e="@friends"}else{if(e==="SELF"||!e){e="@self"}}return{userId:f,groupId:e}};JsonRpcContainer.prototype.newFetchPersonRequest=function(f,e){var c=this.newFetchPeopleRequest(this.makeIdSpec(f),e);var d=this;return new b(c.rpc,function(g){return d.createPersonFromJson(g,e)})};JsonRpcContainer.prototype.newFetchPeopleRequest=function(c,e){var f={method:"people.get"};f.params=this.translateIdSpec(c);FieldTranslations.addAppDataAsProfileFields(e);FieldTranslations.translateStandardArguments(e,f.params);FieldTranslations.translateNetworkDistance(c,f.params);if(e.profileDetail){FieldTranslations.translateJsPersonFieldsToServerFields(e.profileDetail);f.params.fields=e.profileDetail}var d=this;return new b(f,function(k){var j;if(k.list){j=k.list}else{j=[k]}var h=[];for(var g=0;g<j.length;g++){h.push(d.createPersonFromJson(j[g],e))}return new opensocial.Collection(h,k.startIndex,k.totalResults)})};JsonRpcContainer.prototype.createPersonFromJson=function(c,d){FieldTranslations.translateServerPersonToJsPerson(c,d);return new JsonPerson(c)};JsonRpcContainer.prototype.getFieldsList=function(c){if(this.hasNoKeys(c)||this.isWildcardKey(c[0])){return[]}else{return c}};JsonRpcContainer.prototype.hasNoKeys=function(c){return !c||c.length===0};JsonRpcContainer.prototype.isWildcardKey=function(c){return c==="*"};JsonRpcContainer.prototype.newFetchPersonAppDataRequest=function(c,e,d){var f={method:"appdata.get"};f.params=this.translateIdSpec(c);f.params.appId="@app";f.params.fields=this.getFieldsList(e);FieldTranslations.translateNetworkDistance(c,f.params);return new b(f,function(g){return opensocial.Container.escape(g,d,true)})};JsonRpcContainer.prototype.newUpdatePersonAppDataRequest=function(c,d){var e={method:"appdata.update"};e.params={userId:["@viewer"],groupId:"@self"};e.params.appId="@app";e.params.data={};e.params.data[c]=d;e.params.fields=c;return new b(e)};JsonRpcContainer.prototype.newRemovePersonAppDataRequest=function(c){var d={method:"appdata.delete"};d.params={userId:["@viewer"],groupId:"@self"};d.params.appId="@app";d.params.fields=this.getFieldsList(c);return new b(d)};JsonRpcContainer.prototype.newFetchActivitiesRequest=function(c,d){var e={method:"activities.get"};e.params=this.translateIdSpec(c);e.params.appId="@app";FieldTranslations.translateStandardArguments(d,e.params);FieldTranslations.translateNetworkDistance(c,e.params);return new b(e,function(g){g=g.list;var h=[];for(var f=0;f<g.length;f++){h.push(new JsonActivity(g[f]))}return new opensocial.Collection(h)})};JsonRpcContainer.prototype.newActivity=function(c){return new JsonActivity(c,true)};JsonRpcContainer.prototype.newMediaItem=function(e,c,d){d=d||{};d.mimeType=e;d.url=c;return new JsonMediaItem(d)};JsonRpcContainer.prototype.newCreateActivityRequest=function(c,d){var e={method:"activities.create"};e.params=this.translateIdSpec(c);e.params.appId="@app";FieldTranslations.translateNetworkDistance(c,e.params);e.params.activity=d.toJsonObject();return new b(e)};JsonRpcContainer.prototype.invalidateCache=function(){var g={method:"cache.invalidate"};var d={invalidationKeys:["@viewer"]};g.params=d;var f={CONTENT_TYPE:"JSON",METHOD:"POST",AUTHORIZATION:"SIGNED",POST_DATA:gadgets.json.stringify(g)};var c=[this.baseUrl_,"/gadgets/api/rpc"];var e=shindig.auth.getSecurityToken();if(e){c.push("?st=",encodeURIComponent(e))}this.sendRequest(c.join(""),null,f,"application/json")}})();JsonRpcContainer.prototype.newMessage=function(a,b){return new JsonMessage(a,b)};JsonRpcContainer.prototype.newMessageCollection=function(a){return new JsonMessageCollection(a)};JsonRpcContainer.prototype.newFetchMessageCollectionsRequest=function(a,b){var c={method:"messages.get"};c.params=this.translateIdSpec(a);return new JsonRpcRequestItem(c,function(e){e=e.list;var f=[];for(var d=0;d<e.length;d++){f.push(new JsonMessageCollection(e[d]))}return new opensocial.Collection(f)})};JsonRpcContainer.prototype.newFetchMessagesRequest=function(a,c,b){var d={method:"messages.get"};d.params=this.translateIdSpec(a);d.params.msgCollId=c;return new JsonRpcRequestItem(d,function(g){g=g.list;var f=[];for(var e=0;e<g.length;e++){f.push(new JsonMessage(g[e]))}return new opensocial.Collection(f)})};var JsonRpcRequestItem=function(b,a){this.rpc=b;this.processData=a||function(c){return c};this.processResponse=function(c,f,e,d){var g=e?JsonRpcContainer.translateHttpError("Error "+e.code):null;return new opensocial.ResponseItem(c,e?null:this.processData(f),g,d)}};